<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤œå¸‚å½ˆç æª¯ | Night Market Pinball</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fce7f3; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border: 2px solid #fbcfe8; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        canvas { touch-action: none; background: #fffbeb; border-radius: 12px; border: 4px solid #f59e0b; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        .pixel-font { font-family: monospace; }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }
        .btn-pulse { animation: pulse-ring 2s infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4">
    <div class="w-full max-w-md">
        <a href="../../index.html" class="inline-flex items-center text-sm text-pink-600 hover:text-pink-800 mb-4 transition-colors">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            å›é¦–é  Back to Home
        </a>

        <div class="glass-panel rounded-2xl p-6 text-center">
            <h1 class="text-3xl font-bold text-pink-600 mb-2 drop-shadow-sm">å¤œå¸‚å½ˆç æª¯</h1>
            <p class="text-stone-500 text-sm mb-4">é€™å±€è€é—†ä¸ç®—éŒ¢ï¼Œç·´å¥½æ‰‹æ°£å†å»æ‹¼é¦™è…¸ï¼</p>
            
            <div class="flex justify-between items-center mb-4 px-2">
                <div class="text-left">
                    <div class="text-xs text-stone-500 uppercase tracking-wider">Balls</div>
                    <div id="ball-count" class="text-2xl font-bold text-blue-600 font-mono">15</div>
                </div>
                <div class="text-right">
                    <div class="text-xs text-stone-500 uppercase tracking-wider">Score</div>
                    <div id="score-display" class="text-2xl font-bold text-red-600 font-mono">0</div>
                </div>
            </div>

            <div class="relative mx-auto mb-6" style="width: 300px; height: 400px;">
                <canvas id="gameCanvas" width="300" height="400"></canvas>
                <div id="message-overlay" class="absolute inset-0 flex items-center justify-center bg-black/60 rounded-xl hidden">
                    <div class="text-white text-center p-4">
                        <h3 class="text-xl font-bold mb-2" id="msg-title">æ­å–œä¸­çï¼</h3>
                        <p class="text-sm mb-4" id="msg-body">ç²å¾—é¦™è…¸ä¸€æ¢</p>
                        <button onclick="resetGame()" class="bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-2 px-6 rounded-full shadow-lg transition transform hover:scale-105">å†ç©ä¸€æ¬¡</button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="shoot-btn" class="col-span-2 bg-gradient-to-r from-pink-500 to-red-500 hover:from-pink-600 hover:to-red-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg active:scale-95 transition-all select-none touch-manipulation">
                    é•·æŒ‰è“„åŠ›ç™¼å°„ (Hold to Shoot)
                </button>
            </div>

            <!-- Prize Table -->
            <div class="bg-white/50 rounded-xl p-4 text-left border border-stone-100">
                <h3 class="text-sm font-bold text-stone-700 mb-2 flex items-center">
                    <span class="mr-2">ğŸ</span> çå“å…Œæ›è¡¨ (Prize List)
                </h3>
                <div class="space-y-1 text-xs text-stone-600">
                    <div class="flex justify-between border-b border-stone-100 pb-1"><span>300+ åˆ†</span> <span class="font-bold text-pink-600">è¶…å¤§å¨ƒå¨ƒ (Big Doll)</span></div>
                    <div class="flex justify-between border-b border-stone-100 pb-1"><span>200-299 åˆ†</span> <span class="font-bold text-red-500">çƒ¤é¦™è…¸ x3 (Sausage x3)</span></div>
                    <div class="flex justify-between border-b border-stone-100 pb-1"><span>100-199 åˆ†</span> <span class="font-bold text-orange-500">ç§‘å­¸éºµ (Noodles)</span></div>
                    <div class="flex justify-between border-b border-stone-100 pb-1"><span>50-99 åˆ†</span> <span class="font-bold text-yellow-600">æ²™å£«ç³– (Candy)</span></div>
                    <div class="flex justify-between"><span>0-49 åˆ†</span> <span class="text-stone-400">éŠ˜è¬æƒ é¡§ (Thank you)</span></div>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-xs text-stone-400">
            Created by AI Agent on 2026-02-10
        </footer>
    </div>

    <script>
        // Game Configuration
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        let balls = 15;
        let score = 0;
        let isShooting = false;
        let power = 0;
        let powerDirection = 1;
        let activeBall = null; // Object {x, y, vx, vy, radius}
        let settledBalls = []; // Array of objects (for visuals only)
        
        // Physics Constants
        const GRAVITY = 0.25;
        const FRICTION = 0.98;
        const BOUNCE = 0.7;
        const BALL_RADIUS = 6;
        
        // Board Layout
        const PINS = [];
        const PIN_RADIUS = 3;
        const SLOTS = [
            {x: 30, w: 40, score: 10},
            {x: 70, w: 40, score: 20},
            {x: 110, w: 40, score: 50}, // Center is harder
            {x: 150, w: 40, score: 100}, // Jackpot
            {x: 190, w: 40, score: 50},
            {x: 230, w: 40, score: 20},
            {x: 270, w: 40, score: 10}
        ];
        
        // Initialize Pins (Pegs)
        function initPins() {
            // Standard triangular layout or random grid
            for (let y = 80; y < 300; y += 40) {
                const oddRow = (y / 40) % 2 === 0;
                const startX = oddRow ? 40 : 60;
                for (let x = startX; x < 280; x += 40) {
                    // Add some jitter for "handmade" feel
                    PINS.push({x: x + (Math.random()*4-2), y: y + (Math.random()*4-2)});
                }
            }
        }
        initPins();

        // Game Loop
        function update() {
            ctx.clearRect(0, 0, width, height);
            
            // Draw Board Background details
            drawBoard();

            // Draw Pins
            ctx.fillStyle = '#d97706'; // amber-600
            PINS.forEach(pin => {
                ctx.beginPath();
                ctx.arc(pin.x, pin.y, PIN_RADIUS, 0, Math.PI * 2);
                ctx.fill();
            });

            // Handle Power Meter
            if (isShooting && !activeBall && balls > 0) {
                power += 2 * powerDirection;
                if (power > 100) { power = 100; powerDirection = -1; }
                if (power < 0) { power = 0; powerDirection = 1; }
                
                // Draw Power Indicator
                ctx.fillStyle = `hsl(${120 - power}, 80%, 50%)`;
                ctx.fillRect(width - 20, height - 10 - (power * 1.5), 10, power * 1.5);
            }

            // Update Active Ball
            if (activeBall) {
                // Apply Gravity
                activeBall.vy += GRAVITY;
                activeBall.vx *= 0.995; // Air resistance

                // Update Position
                activeBall.x += activeBall.vx;
                activeBall.y += activeBall.vy;

                // Wall Collisions
                if (activeBall.x < BALL_RADIUS) {
                    activeBall.x = BALL_RADIUS;
                    activeBall.vx *= -BOUNCE;
                } else if (activeBall.x > width - 25) { // Right channel wall
                    // Check if it's still in the launch channel (bottom right)
                    if (activeBall.y > 100 && activeBall.x > width - 30) {
                        // In launch channel, constraint is width
                         if (activeBall.x > width - BALL_RADIUS) {
                             activeBall.x = width - BALL_RADIUS;
                             activeBall.vx *= -BOUNCE;
                         }
                    } else {
                        // Main area right wall
                         if (activeBall.x > width - 30) {
                             activeBall.x = width - 30;
                             activeBall.vx *= -BOUNCE;
                         }
                    }
                }

                // Pin Collisions
                PINS.forEach(pin => {
                    const dx = activeBall.x - pin.x;
                    const dy = activeBall.y - pin.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < BALL_RADIUS + PIN_RADIUS) {
                        // Simple elastic collision response
                        const angle = Math.atan2(dy, dx);
                        const speed = Math.sqrt(activeBall.vx**2 + activeBall.vy**2);
                        
                        // Bounce off pin
                        activeBall.vx = Math.cos(angle) * speed * BOUNCE + (Math.random()-0.5); // Add randomness
                        activeBall.vy = Math.sin(angle) * speed * BOUNCE;
                        
                        // Push out of collision
                        const overlap = (BALL_RADIUS + PIN_RADIUS) - dist;
                        activeBall.x += Math.cos(angle) * overlap;
                        activeBall.y += Math.sin(angle) * overlap;
                    }
                });

                // Bottom Slots Logic
                if (activeBall.y > height - BALL_RADIUS - 10) {
                    // Determine slot
                    let landed = false;
                    // Check which slot x falls into
                    // Slots are roughly width/8 wide
                    // Simple logic: map x to score
                    // Slots visual separation is needed
                    
                    if (Math.abs(activeBall.vy) < 0.5 && Math.abs(activeBall.vx) < 0.5) {
                         // Ball stopped or moving very slow at bottom
                         landed = true;
                    } else if (activeBall.y > height - BALL_RADIUS) {
                         // Hit floor, bounce
                         activeBall.y = height - BALL_RADIUS;
                         activeBall.vy *= -0.5;
                         activeBall.vx *= 0.8; // Ground friction
                         if (Math.abs(activeBall.vy) < 1) landed = true;
                    }

                    if (landed) {
                        finishBall();
                    }
                }
                
                drawBall(activeBall);
            }

            // Draw Settled Balls (just static circles at bottom for now, simplified)
            // Or just keep score. Let's not draw piled up balls to keep it simple, just score.
            
            requestAnimationFrame(update);
        }

        function drawBoard() {
            // Draw Slots
            const slotWidth = (width - 40) / 7;
            for (let i = 0; i < 7; i++) {
                const x = 20 + i * slotWidth;
                ctx.strokeStyle = '#e5e7eb';
                ctx.beginPath();
                ctx.moveTo(x, 300);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                // Score Text
                ctx.fillStyle = '#9ca3af';
                ctx.font = '10px monospace';
                // Scores: 10, 20, 50, 100, 50, 20, 10
                const scores = [10, 20, 50, 100, 50, 20, 10];
                ctx.fillText(scores[i], x + slotWidth/2 - 6, height - 5);
            }
            
            // Launch Channel
            ctx.fillStyle = '#fef3c7';
            ctx.fillRect(width - 25, 100, 25, height - 100);
            ctx.strokeStyle = '#d97706';
            ctx.beginPath();
            ctx.moveTo(width - 25, 100);
            ctx.lineTo(width - 25, height);
            ctx.stroke();
            
            // Curve Top Right
            ctx.beginPath();
            ctx.moveTo(width - 25, 100);
            ctx.quadraticCurveTo(width - 25, 20, width/2, 20);
            ctx.stroke();
        }

        function drawBall(ball) {
            ctx.fillStyle = 'silver';
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, BALL_RADIUS, 0, Math.PI * 2);
            ctx.fill();
            // Shine
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(ball.x - 2, ball.y - 2, 2, 0, Math.PI * 2);
            ctx.fill();
        }

        function finishBall() {
            // Calculate score based on X position
            const slotWidth = (width - 40) / 7;
            const x = activeBall.x - 20; // Offset
            let slotIndex = Math.floor(x / slotWidth);
            if (slotIndex < 0) slotIndex = 0;
            if (slotIndex > 6) slotIndex = 6;
            
            const scores = [10, 20, 50, 100, 50, 20, 10];
            const points = scores[slotIndex];
            
            score += points;
            document.getElementById('score-display').innerText = score;
            
            activeBall = null;
            
            if (balls === 0) {
                endGame();
            }
        }

        function endGame() {
            const overlay = document.getElementById('message-overlay');
            const title = document.getElementById('msg-title');
            const body = document.getElementById('msg-body');
            
            let prize = "éŠ˜è¬æƒ é¡§ (Thank You)";
            if (score >= 300) prize = "ğŸ† è¶…å¤§å¨ƒå¨ƒ (Big Doll)!";
            else if (score >= 200) prize = "ğŸ– çƒ¤é¦™è…¸ x3 (Sausages)!";
            else if (score >= 100) prize = "ğŸœ ç§‘å­¸éºµ (Noodles)!";
            else if (score >= 50) prize = "ğŸ¬ æ²™å£«ç³– (Candy)!";
            
            title.innerText = score >= 50 ? "æ­å–œä¸­çï¼" : "å†æ¥å†å²ï¼";
            body.innerText = `ç¸½åˆ†: ${score}\nç²å¾—: ${prize}`;
            overlay.classList.remove('hidden');
        }

        function resetGame() {
            balls = 15;
            score = 0;
            activeBall = null;
            document.getElementById('ball-count').innerText = balls;
            document.getElementById('score-display').innerText = score;
            document.getElementById('message-overlay').classList.add('hidden');
        }

        // Controls
        const btn = document.getElementById('shoot-btn');
        
        // Mouse/Touch Events
        btn.addEventListener('mousedown', startCharge);
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); startCharge(); });
        
        btn.addEventListener('mouseup', releaseCharge);
        btn.addEventListener('touchend', releaseCharge);
        btn.addEventListener('mouseleave', () => { if(isShooting) releaseCharge(); });

        function startCharge() {
            if (balls <= 0 || activeBall) return;
            isShooting = true;
            power = 0;
        }

        function releaseCharge() {
            if (!isShooting) return;
            isShooting = false;
            
            if (balls > 0) {
                balls--;
                document.getElementById('ball-count').innerText = balls;
                
                // Launch logic
                // Max speed ~20
                const speed = 10 + (power / 100) * 15;
                
                activeBall = {
                    x: width - 12, // In launch channel
                    y: height - 20,
                    vx: 0,
                    vy: -speed, // Shoot up
                    radius: BALL_RADIUS
                };
            }
        }

        // Start loop
        update();

    </script>
</body>
</html>
