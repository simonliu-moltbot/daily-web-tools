<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â§úÂ∏ÇÂΩàÁè†Ê™Ø | Night Market Pinball</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #fce7f3; overflow: hidden; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); border: 2px solid #fbcfe8; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        canvas { touch-action: none; background: #fffbeb; border-radius: 12px; border: 4px solid #f59e0b; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }
        .pixel-font { font-family: monospace; }
        @keyframes pulse-ring {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(234, 179, 8, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }
        .btn-pulse { animation: pulse-ring 2s infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-2 px-4">
    <div class="w-full max-w-md">
        <a href="../../index.html" class="inline-flex items-center text-xs text-pink-600 hover:text-pink-800 mb-2 transition-colors">
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            ÂõûÈ¶ñÈ†Å Back to Home
        </a>

        <div class="glass-panel rounded-2xl p-4 text-center">
            <h1 class="text-2xl font-bold text-pink-600 mb-1 drop-shadow-sm">üéØ Â§úÂ∏ÇÂΩàÁè†Ê™Ø</h1>
            
            <div class="flex justify-between items-center mb-2 px-2">
                <div class="text-left">
                    <div class="text-[10px] text-stone-500 uppercase tracking-wider font-bold">Balls Ââ©È§òÁêÉÊï∏</div>
                    <div id="ball-count" class="text-xl font-bold text-blue-600 font-mono tracking-tighter">15</div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] text-stone-500 uppercase tracking-wider font-bold">Score ÁõÆÂâçÂæóÂàÜ</div>
                    <div id="score-display" class="text-xl font-bold text-red-600 font-mono tracking-tighter">0</div>
                </div>
            </div>

            <div class="relative mx-auto mb-4" style="width: 300px; height: 450px;">
                <canvas id="gameCanvas" width="300" height="450"></canvas>
                <div id="message-overlay" class="absolute inset-0 flex items-center justify-center bg-black/70 rounded-xl hidden z-50">
                    <div class="text-white text-center p-6">
                        <h3 class="text-2xl font-bold mb-2 text-yellow-400" id="msg-title">ÈÅäÊà≤ÁµêÊùü</h3>
                        <p class="text-lg mb-6 leading-relaxed" id="msg-body"></p>
                        <button onclick="resetGame()" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-10 rounded-full shadow-xl transition transform active:scale-95">ÂÜçÁé©‰∏ÄÊ¨°</button>
                    </div>
                </div>
            </div>

            <div class="flex flex-col gap-2 mb-4">
                <button id="shoot-btn" class="bg-gradient-to-b from-yellow-400 to-amber-600 hover:from-yellow-500 hover:to-amber-700 text-white font-bold py-4 px-6 rounded-2xl shadow-lg active:scale-95 transition-all select-none touch-manipulation border-b-4 border-amber-800">
                    PUSH & HOLD (ÊãâÊ°øËìÑÂäõ)
                </button>
            </div>

            <div class="bg-white/50 rounded-xl p-3 text-left border border-stone-100">
                <h3 class="text-[10px] font-bold text-stone-700 mb-1 flex items-center">
                    <span class="mr-1">üéÅ</span> ÁçéÂìÅË°® (Prizes)
                </h3>
                <div class="grid grid-cols-2 gap-x-4 text-[10px] text-stone-600 font-bold">
                    <div class="flex justify-between border-b border-pink-100 pb-0.5"><span>300+</span> <span class="text-pink-600">Ë∂ÖÂ§ßÂ®ÉÂ®É</span></div>
                    <div class="flex justify-between border-b border-pink-100 pb-0.5"><span>200+</span> <span class="text-red-500">È¶ôËÖ∏ x3</span></div>
                    <div class="flex justify-between border-b border-pink-100 pb-0.5"><span>100+</span> <span class="text-orange-500">ÁßëÂ≠∏È∫µ</span></div>
                    <div class="flex justify-between border-b border-pink-100 pb-0.5"><span>50+</span> <span class="text-yellow-600">Ê≤ôÂ£´Á≥ñ</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;
        
        let balls = 15;
        let score = 0;
        let isShooting = false;
        let power = 0;
        let powerDirection = 1;
        let activeBall = null;
        
        const GRAVITY = 0.15;
        const BOUNCE = 0.65;
        const BALL_RADIUS = 7;
        const PIN_RADIUS = 4;
        const RIGHT_WALL_X = width - 30;
        
        const PINS = [];
        const SLOTS = [10, 20, 50, 100, 50, 20, 10];

        function initPins() {
            PINS.length = 0;
            for (let y = 120; y < 350; y += 45) {
                const oddRow = (y / 45) % 2 === 0;
                const startX = oddRow ? 40 : 62;
                for (let x = startX; x < RIGHT_WALL_X - 20; x += 45) {
                    PINS.push({x: x + (Math.random()*2-1), y: y + (Math.random()*2-1)});
                }
            }
        }
        initPins();

        function update() {
            ctx.clearRect(0, 0, width, height);
            drawBoard();

            // Draw Pins
            ctx.fillStyle = '#b45309';
            PINS.forEach(pin => {
                ctx.beginPath();
                ctx.arc(pin.x, pin.y, PIN_RADIUS, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.arc(pin.x-1, pin.y-1, 1.5, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#b45309';
            });

            if (isShooting && !activeBall && balls > 0) {
                power += 2 * powerDirection;
                if (power > 100) { power = 100; powerDirection = -1; }
                if (power < 0) { power = 0; powerDirection = 1; }
                
                ctx.fillStyle = `hsl(${120 - power}, 80%, 50%)`;
                ctx.fillRect(width - 25, height - 10 - (power * 3), 20, power * 3);
            }

            if (activeBall) {
                activeBall.vy += GRAVITY;
                activeBall.x += activeBall.vx;
                activeBall.y += activeBall.vy;

                // Left Wall
                if (activeBall.x < BALL_RADIUS) {
                    activeBall.x = BALL_RADIUS;
                    activeBall.vx *= -BOUNCE;
                }
                
                // Top Curve & Launch Channel exit
                if (activeBall.y < 50) {
                    // Curved top
                    const centerX = width / 2;
                    const centerY = 50;
                    const radius = width / 2;
                    const dx = activeBall.x - centerX;
                    const dy = activeBall.y - centerY;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist > radius - BALL_RADIUS) {
                        const angle = Math.atan2(dy, dx);
                        activeBall.x = centerX + Math.cos(angle) * (radius - BALL_RADIUS);
                        activeBall.y = centerY + Math.sin(angle) * (radius - BALL_RADIUS);
                        // Simple reflection for curve
                        const normalX = -Math.cos(angle);
                        const normalY = -Math.sin(angle);
                        const dot = activeBall.vx * normalX + activeBall.vy * normalY;
                        activeBall.vx = (activeBall.vx - 2 * dot * normalX) * BOUNCE;
                        activeBall.vy = (activeBall.vy - 2 * dot * normalY) * BOUNCE;
                    }
                }

                // Channel Wall & Right Wall
                if (activeBall.x > RIGHT_WALL_X - BALL_RADIUS) {
                    if (activeBall.y > 100) {
                        // In launch channel (rightmost)
                        if (activeBall.x > width - BALL_RADIUS) {
                            activeBall.x = width - BALL_RADIUS;
                            activeBall.vx *= -BOUNCE;
                        }
                        if (activeBall.vx < 0 && activeBall.x < RIGHT_WALL_X + BALL_RADIUS) {
                             activeBall.x = RIGHT_WALL_X + BALL_RADIUS;
                             activeBall.vx *= -BOUNCE;
                        }
                    } else if (activeBall.x > width - BALL_RADIUS) {
                        // Top right exit
                        activeBall.x = width - BALL_RADIUS;
                        activeBall.vx *= -BOUNCE;
                    }
                }

                // Pin Collisions (More realistic reflection)
                PINS.forEach(pin => {
                    const dx = activeBall.x - pin.x;
                    const dy = activeBall.y - pin.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < BALL_RADIUS + PIN_RADIUS) {
                        const nx = dx / dist;
                        const ny = dy / dist;
                        const dot = activeBall.vx * nx + activeBall.vy * ny;
                        activeBall.vx = (activeBall.vx - 2 * dot * nx) * BOUNCE + (Math.random()*0.4 - 0.2);
                        activeBall.vy = (activeBall.vy - 2 * dot * ny) * BOUNCE;
                        activeBall.x = pin.x + nx * (BALL_RADIUS + PIN_RADIUS);
                        activeBall.y = pin.y + ny * (BALL_RADIUS + PIN_RADIUS);
                    }
                });

                // Scoring Slots
                if (activeBall.y > height - BALL_RADIUS) {
                    finishBall();
                }
                
                drawBall(activeBall);
            }

            requestAnimationFrame(update);
        }

        function drawBoard() {
            // Slots Dividers
            const slotWidth = RIGHT_WALL_X / 7;
            for (let i = 0; i <= 7; i++) {
                const x = i * slotWidth;
                ctx.strokeStyle = '#f59e0b';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(x, 380);
                ctx.lineTo(x, height);
                ctx.stroke();
                
                if (i < 7) {
                    ctx.fillStyle = '#d97706';
                    ctx.font = 'bold 12px monospace';
                    ctx.fillText(SLOTS[i], x + slotWidth/2 - 10, height - 10);
                }
            }
            
            // Launch Channel
            ctx.fillStyle = '#fef3c7';
            ctx.fillRect(RIGHT_WALL_X, 100, 30, height - 100);
            ctx.strokeStyle = '#f59e0b';
            ctx.beginPath();
            ctx.moveTo(RIGHT_WALL_X, 100);
            ctx.lineTo(RIGHT_WALL_X, height);
            ctx.stroke();
            
            // Top Curve Boundary
            ctx.beginPath();
            ctx.lineWidth = 4;
            ctx.arc(width/2, 50, width/2, Math.PI, 0);
            ctx.stroke();
        }

        function drawBall(ball) {
            ctx.save();
            ctx.shadowBlur = 5;
            ctx.shadowColor = 'rgba(0,0,0,0.2)';
            ctx.fillStyle = '#94a3b8';
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, BALL_RADIUS, 0, Math.PI * 2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(ball.x - 2, ball.y - 2, 2, 0, Math.PI * 2);
            ctx.fill();
            ctx.restore();
        }

        function finishBall() {
            const slotWidth = RIGHT_WALL_X / 7;
            let slotIndex = Math.floor(activeBall.x / slotWidth);
            if (slotIndex < 0) slotIndex = 0;
            if (slotIndex > 6) slotIndex = 6;
            
            score += SLOTS[slotIndex];
            document.getElementById('score-display').innerText = score;
            
            activeBall = null;
            isShooting = false; // Âº∑Âà∂ÈáçÁΩÆÁôºÂ∞ÑÈéñÂÆöÁãÄÊÖã
            
            if (balls === 0) endGame();
        }

        function endGame() {
            const overlay = document.getElementById('message-overlay');
            const body = document.getElementById('msg-body');
            let prize = "ÈäòË¨ùÊÉ†È°ß üò≠";
            if (score >= 300) prize = "ü•á Ë∂ÖÂ§ßÂ®ÉÂ®É (Big Doll)";
            else if (score >= 200) prize = "üå≠ ÁÉ§È¶ôËÖ∏ x3 (Sausages)";
            else if (score >= 100) prize = "üçú ÁßëÂ≠∏È∫µ (Noodles)";
            else if (score >= 50) prize = "üç¨ Ê≤ôÂ£´Á≥ñ (Candy)";
            
            body.innerHTML = `Á∏ΩÂàÜ Score: <span class="text-3xl text-white font-mono">${score}</span><br><br>${prize}`;
            overlay.classList.remove('hidden');
        }

        function resetGame() {
            balls = 15;
            score = 0;
            activeBall = null;
            isShooting = false;
            document.getElementById('ball-count').innerText = balls;
            document.getElementById('score-display').innerText = score;
            document.getElementById('message-overlay').classList.add('hidden');
            initPins();
        }

        const btn = document.getElementById('shoot-btn');
        const startEvents = ['mousedown', 'touchstart'];
        const endEvents = ['mouseup', 'touchend', 'mouseleave'];

        startEvents.forEach(e => btn.addEventListener(e, (evt) => {
            if (e === 'touchstart') evt.preventDefault();
            if (balls <= 0 || activeBall) return;
            isShooting = true;
            power = 0;
        }));

        endEvents.forEach(e => btn.addEventListener(e, () => {
            if (!isShooting) return;
            isShooting = false;
            balls--;
            document.getElementById('ball-count').innerText = balls;
            const speed = 8 + (power / 100) * 12;
            activeBall = { x: width - 15, y: height - 20, vx: 0, vy: -speed, radius: BALL_RADIUS };
        }));

        update();
    </script>
</body>
</html>
