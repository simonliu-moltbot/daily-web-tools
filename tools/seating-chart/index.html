<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å®Œç¾æ’æ¡Œï¼šå©šç¦®/æ™šå®´åº§ä½å®‰æ’ç¥å™¨ | Seating Chart Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; overscroll-behavior: none; }
        .guest-chip { cursor: grab; touch-action: pan-y; user-select: none; -webkit-user-select: none; }
        .guest-chip:active { cursor: grabbing; }
        .drop-zone { min-height: 50px; transition: background-color 0.2s; }
        .drop-zone.drag-over { background-color: #fee2e2; border-color: #ef4444; }
        
        /* Table Dragging */
        .venue-canvas { 
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px); 
            background-size: 20px 20px; 
            width: 2000px; 
            height: 2000px; 
            position: relative; 
            cursor: grab;
            /* Default transform origin for printing */
            transform-origin: top left;
        }
        .venue-canvas:active { cursor: grabbing; }
        .draggable-table { position: absolute; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); touch-action: none; }
        .draggable-table.is-dragging { opacity: 0.8; z-index: 50; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); cursor: grabbing; }

        [x-cloak] { display: none !important; }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @media print {
            @page { size: landscape; margin: 5mm; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            
            /* Print Modes */
            body.print-map .venue-container { display: flex !important; justify-content: center; align-items: center; overflow: visible !important; width: 100vw !important; height: 100vh !important; }
            body.print-map .venue-canvas { 
                /* Centering logic handled by JS auto-scaling */
                background: none; 
                border: none;
            } 
            body.print-map #list-view-container { display: none !important; }
            
            body.print-list .venue-container { display: none !important; }
            body.print-list #list-view-container { display: block !important; width: 100% !important; height: auto !important; overflow: visible !important; }
            body.print-list .list-grid { display: grid !important; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
            body.print-list .list-card { break-inside: avoid; border: 1px solid #ddd; box-shadow: none; }

            header, aside { display: none !important; }
        }
    </style>
</head>
<body class="h-[100dvh] flex flex-col overflow-hidden" x-data="seatingApp()" :class="printMode">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between shrink-0 z-30 no-print shadow-sm">
        <div class="flex items-center gap-3">
            <a href="../../index.html" class="text-gray-400 hover:text-gray-600 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
            </a>
            <div>
                <h1 class="text-lg font-bold text-gray-800 leading-tight">å®Œç¾æ’æ¡Œ</h1>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <div class="hidden md:flex bg-gray-100 rounded-lg p-1 mr-2">
                <button @click="viewMode='list'" :class="{'bg-white shadow text-indigo-600': viewMode==='list', 'text-gray-500': viewMode!=='list'}" class="px-3 py-1 rounded text-xs font-bold transition">åˆ—è¡¨æ¨¡å¼</button>
                <button @click="viewMode='map'" :class="{'bg-white shadow text-indigo-600': viewMode==='map', 'text-gray-500': viewMode!=='map'}" class="px-3 py-1 rounded text-xs font-bold transition">æœƒå ´åœ°åœ–</button>
            </div>
            
            <div class="hidden md:flex items-center gap-1 border-l border-gray-200 pl-3 ml-1">
                <button @click="print('list')" class="flex items-center gap-1 px-3 py-1.5 bg-gray-50 text-gray-700 rounded hover:bg-gray-100 transition text-xs font-medium border border-gray-200">
                    ğŸ“„ å°åå–®
                </button>
                <button @click="print('map')" class="flex items-center gap-1 px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded hover:bg-indigo-100 transition text-xs font-medium border border-indigo-200">
                    ğŸ—ºï¸ å°åœ°åœ–
                </button>
            </div>
            
            <button @click="saveData()" class="flex items-center gap-2 px-3 py-1.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-sm shadow-sm active:scale-95 ml-2">
                <span class="hidden md:inline">å„²å­˜</span>
                <svg class="w-4 h-4 md:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/></svg>
            </button>
            
            <!-- Mobile Menu -->
            <div class="relative md:hidden" x-data="{ open: false }">
                <button @click="open = !open" class="p-1 text-gray-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"/></svg></button>
                <div x-show="open" @click.outside="open = false" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 border border-gray-100 z-50">
                    <button @click="viewMode = viewMode === 'list' ? 'map' : 'list'; open=false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" x-text="viewMode === 'list' ? 'åˆ‡æ›åœ°åœ–æ¨¡å¼' : 'åˆ‡æ›åˆ—è¡¨æ¨¡å¼'"></button>
                    <button @click="print('list'); open=false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">ğŸ“„ åˆ—å°åå–®</button>
                    <button @click="print('map'); open=false" class="block w-full text-left px-4 py-2 text-sm text-indigo-600 hover:bg-indigo-50">ğŸ—ºï¸ åˆ—å°åœ°åœ–</button>
                    <button @click="resetAll(); open=false" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50">å…¨éƒ¨é‡ç½®</button>
                </div>
            </div>
        </div>
    </header>

    <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
        
        <!-- Sidebar -->
        <aside class="w-full md:w-72 h-[30vh] md:h-auto bg-white border-b md:border-b-0 md:border-r border-gray-200 flex flex-col shrink-0 no-print z-20 shadow-sm relative order-first">
            <div class="p-3 border-b border-gray-100 bg-white">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="font-bold text-gray-700 text-sm flex items-center gap-2">
                        å¾…åˆ†é…è³“å®¢ 
                        <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded-full" x-text="guests.filter(g => !g.tableId).length"></span>
                    </h2>
                    <button @click="toggleBulkImport()" class="text-xs text-indigo-600 font-medium">åŒ¯å…¥</button>
                </div>
                <!-- Add Guest Input Area -->
                <div class="flex flex-col gap-2 mb-2">
                    <input type="text" x-model="newGuestName" @keydown.enter="addGuest()" placeholder="è¼¸å…¥å§“å..." class="w-full px-3 py-1.5 bg-gray-50 border border-gray-200 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <div class="flex justify-between items-center">
                        <div class="flex gap-2">
                            <button @click="newGuestTags.baby = !newGuestTags.baby" 
                                    class="text-xs px-2 py-1 rounded border transition flex items-center gap-1"
                                    :class="newGuestTags.baby ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-gray-50 border-gray-200 text-gray-400'">
                                ğŸ‘¶ å¬°å…’
                            </button>
                            <button @click="newGuestTags.veg = !newGuestTags.veg" 
                                    class="text-xs px-2 py-1 rounded border transition flex items-center gap-1"
                                    :class="newGuestTags.veg ? 'bg-green-50 border-green-200 text-green-600' : 'bg-gray-50 border-gray-200 text-gray-400'">
                                ğŸ¥— ç´ é£Ÿ
                            </button>
                        </div>
                        <button @click="addGuest()" class="px-3 py-1 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition text-xs font-bold">
                            æ–°å¢
                        </button>
                    </div>
                </div>
                
                <div x-show="showBulkImport" x-transition class="absolute top-14 left-2 right-2 bg-white shadow-xl border border-gray-200 p-3 rounded-lg z-50">
                    <textarea x-model="bulkNames" placeholder="è²¼ä¸Šåå–®ï¼Œä¸€è¡Œä¸€å€‹åå­—" class="w-full h-32 p-2 text-sm border border-gray-200 rounded mb-2"></textarea>
                    <div class="flex justify-end gap-2">
                        <button @click="showBulkImport=false" class="text-xs px-3 py-1.5 border rounded">å–æ¶ˆ</button>
                        <button @click="processBulkImport()" class="text-xs px-3 py-1.5 bg-indigo-600 text-white rounded">ç¢ºå®šåŒ¯å…¥</button>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-2 bg-gray-50/50">
                <div id="guest-pool" class="grid grid-cols-2 md:grid-cols-1 gap-2 min-h-[50px]">
                    <template x-for="guest in guests.filter(g => !g.tableId)" :key="guest.id">
                        <div :data-id="guest.id" 
                             @click="openAssignModal(guest)"
                             class="guest-chip group bg-white border border-gray-200 p-2 rounded shadow-sm hover:border-indigo-400 active:border-indigo-600 transition flex justify-between items-center touch-manipulation">
                            <div class="flex items-center gap-1 overflow-hidden">
                                <span class="text-gray-700 font-medium text-sm truncate" x-text="guest.name"></span>
                                <span x-show="guest.isBaby" class="text-xs" title="å¬°å…’">ğŸ‘¶</span>
                                <span x-show="guest.isVeg" class="text-xs" title="ç´ é£Ÿ">ğŸ¥—</span>
                            </div>
                            <button @click.stop="deleteGuest(guest.id)" class="hidden md:block text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition">Ã—</button>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="md:hidden bg-indigo-50 text-indigo-800 text-[10px] py-1 text-center font-medium border-t border-indigo-100">
                é»æ“Šåå­—åˆ†é…ï¼Œæ‹–æ›³ç§»å‹•æ¡Œå­ (åœ°åœ–æ¨¡å¼)
            </div>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 bg-gray-100 overflow-hidden relative">
            
            <!-- LIST MODE (Classic Grid) -->
            <div id="list-view-container" x-show="viewMode === 'list'" class="h-full overflow-y-auto p-4 md:p-8">
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 md:gap-8 pb-24 list-grid">
                     <template x-for="table in tables" :key="table.id">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-3 flex flex-col list-card">
                            <!-- Header -->
                            <div class="flex justify-between items-center mb-2 border-b border-gray-100 pb-2">
                                <div class="flex items-center gap-2 flex-1">
                                    <input type="text" x-model="table.name" class="font-bold text-base text-gray-800 bg-transparent border-none focus:ring-0 w-full p-0">
                                </div>
                                <button @click="editTable(table)" class="text-gray-400 hover:text-indigo-500 p-1 no-print"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg></button>
                            </div>
                            <!-- Guests -->
                             <div :id="'list-table-' + table.id" class="space-y-1 min-h-[60px]">
                                <template x-for="guest in getTableGuests(table.id)" :key="guest.id">
                                    <div :data-id="guest.id" @click="openAssignModal(guest)" class="bg-gray-50 p-2 rounded text-sm flex justify-between items-center">
                                        <div class="flex items-center gap-1">
                                            <span x-text="guest.name"></span>
                                            <span x-show="guest.isBaby" class="text-xs">ğŸ‘¶</span>
                                            <span x-show="guest.isVeg" class="text-xs">ğŸ¥—</span>
                                        </div>
                                        <button @click.stop="removeGuestFromTable(guest.id)" class="text-gray-300 hover:text-red-500 no-print">Ã—</button>
                                    </div>
                                </template>
                             </div>
                        </div>
                     </template>
                </div>
            </div>

            <!-- MAP MODE (Canvas) -->
            <div x-show="viewMode === 'map'" class="h-full overflow-auto bg-slate-200 relative venue-container" id="map-scroll-container">
                <div class="venue-canvas" 
                     id="venue-canvas"
                     @mousedown.self="startPan($event)" 
                     @mousemove.window="pan($event)" 
                     @mouseup.window="endPan()">
                    
                    <template x-for="table in tables" :key="table.id">
                        <div :style="`left: ${table.x}px; top: ${table.y}px; width: 220px;`"
                             class="draggable-table bg-white rounded-xl border border-gray-300 p-3 flex flex-col absolute select-none"
                             :class="{'ring-2 ring-indigo-500 z-50': isDraggingTable === table.id}">
                            
                            <!-- Drag Handle -->
                            <div class="cursor-move flex justify-between items-center mb-2 border-b border-gray-100 pb-1"
                                 @mousedown="startDragTable($event, table)"
                                 @touchstart="startDragTableTouch($event, table)">
                                <div class="flex items-center gap-1 overflow-hidden">
                                    <svg class="w-4 h-4 text-gray-400 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"/></svg>
                                    <span class="font-bold text-sm truncate" x-text="table.name"></span>
                                </div>
                                <button @click.stop="editTable(table)" class="text-gray-400 hover:text-indigo-600 no-print"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></button>
                            </div>

                            <!-- Guest List (Sortable) -->
                            <div :id="'map-table-' + table.id" class="space-y-1 min-h-[40px] max-h-[200px] overflow-y-auto">
                                <template x-for="guest in getTableGuests(table.id)" :key="guest.id">
                                    <div :data-id="guest.id" @click="openAssignModal(guest)" class="bg-gray-50 p-1.5 rounded text-xs flex justify-between items-center group">
                                        <div class="flex items-center gap-1 overflow-hidden">
                                            <span class="truncate" x-text="guest.name"></span>
                                            <span x-show="guest.isBaby" class="text-[10px]" title="å¬°å…’">ğŸ‘¶</span>
                                            <span x-show="guest.isVeg" class="text-[10px]" title="ç´ é£Ÿ">ğŸ¥—</span>
                                        </div>
                                        <button @click.stop="removeGuestFromTable(guest.id)" class="hidden group-hover:block text-red-400 no-print">Ã—</button>
                                    </div>
                                </template>
                            </div>

                            <!-- Capacity Indicator -->
                            <div class="mt-2 text-[10px] text-right text-gray-400">
                                <span :class="{'text-red-500 font-bold': getTableGuests(table.id).length > table.seats}" x-text="getTableGuests(table.id).length"></span> / <span x-text="table.seats"></span>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- FAB -->
            <button @click="addTable()" class="fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg flex items-center justify-center hover:bg-indigo-700 active:scale-95 transition z-40 no-print">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
            </button>
        </main>
    </div>

    <!-- Edit Table Modal -->
    <div x-show="editModal.show" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak>
        <div @click.outside="editModal.show = false" class="bg-white rounded-2xl p-6 w-80 shadow-2xl">
            <h3 class="font-bold text-lg mb-4">ç·¨è¼¯æ¡Œæ¬¡</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">åç¨±</label>
                    <input type="text" x-model="editModal.table.name" class="w-full border border-gray-300 rounded p-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">äººæ•¸ä¸Šé™ (Seats)</label>
                    <input type="number" x-model.number="editModal.table.seats" class="w-full border border-gray-300 rounded p-2 text-sm">
                </div>
                <div class="flex items-center gap-2">
                    <input type="checkbox" x-model="editModal.table.isMain" id="isMain" class="rounded text-indigo-600">
                    <label for="isMain" class="text-sm">è¨­ç‚ºä¸»æ¡Œ (ç´…è‰²æ¨™ç¤º)</label>
                </div>
                <button @click="deleteTable(editModal.table.id); editModal.show = false" class="w-full py-2 text-red-500 text-sm border border-red-100 rounded hover:bg-red-50">åˆªé™¤æ­¤æ¡Œ</button>
            </div>
            <div class="mt-6 flex justify-end">
                <button @click="saveData(); editModal.show = false" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- Assignment Modal (Shared) -->
    <div x-show="assignModal.show" class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/50 backdrop-blur-sm" x-cloak>
        <div @click.outside="assignModal.show = false" class="bg-white w-full md:w-96 md:rounded-2xl rounded-t-2xl p-4 shadow-2xl transform transition-transform duration-300">
             <div class="flex justify-between items-center mb-4 border-b border-gray-100 pb-2">
                <div>
                    <h3 class="font-bold text-lg text-gray-800">ç§»å‹• <span class="text-indigo-600" x-text="assignModal.guest?.name"></span></h3>
                    <!-- Tags Toggle in Modal -->
                    <div class="flex gap-2 mt-2" x-if="assignModal.guest">
                        <button @click="assignModal.guest.isBaby = !assignModal.guest.isBaby; saveData()" 
                                class="text-xs px-2 py-1 rounded border transition flex items-center gap-1"
                                :class="assignModal.guest?.isBaby ? 'bg-pink-50 border-pink-200 text-pink-600' : 'bg-gray-50 border-gray-200 text-gray-400'">
                            ğŸ‘¶ å¬°å…’
                        </button>
                        <button @click="assignModal.guest.isVeg = !assignModal.guest.isVeg; saveData()" 
                                class="text-xs px-2 py-1 rounded border transition flex items-center gap-1"
                                :class="assignModal.guest?.isVeg ? 'bg-green-50 border-green-200 text-green-600' : 'bg-gray-50 border-gray-200 text-gray-400'">
                            ğŸ¥— ç´ é£Ÿ
                        </button>
                    </div>
                </div>
                <button @click="assignModal.show = false" class="text-gray-400 bg-gray-100 rounded-full p-1">âœ•</button>
            </div>
            <div class="grid grid-cols-2 gap-2 max-h-[40vh] overflow-y-auto p-1">
                <button @click="moveTo(null)" class="p-3 rounded-xl border-2 border-dashed border-gray-300 text-gray-500 text-left">â†©ï¸ ç§»å›åå–®</button>
                <template x-for="table in tables" :key="table.id">
                    <button @click="moveTo(table.id)" class="p-3 rounded-xl border-2 text-left" :class="assignModal.guest?.tableId === table.id ? 'border-indigo-500 bg-indigo-50' : 'border-gray-100'">
                        <div class="font-bold text-sm" x-text="table.name"></div>
                        <div class="text-xs text-gray-400"><span x-text="getTableGuests(table.id).length"></span> / <span x-text="table.seats"></span></div>
                    </button>
                </template>
            </div>
            
            <div class="mt-4 pt-2 border-t border-gray-100 flex justify-between items-center">
                 <button @click="deleteGuest(assignModal.guest.id); assignModal.show = false" class="text-red-500 text-sm px-2 py-1 flex items-center gap-1 hover:bg-red-50 rounded transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg> åˆªé™¤æ­¤äºº
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-transition.opacity.duration.500ms class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-black/80 text-white px-6 py-3 rounded-full shadow-xl text-sm z-50 flex items-center gap-2" x-cloak>
        <span x-text="toast.icon"></span>
        <span x-text="toast.msg"></span>
    </div>

    <script>
        function seatingApp() {
            return {
                viewMode: 'map', 
                guests: [],
                tables: [],
                newGuestName: '',
                newGuestTags: { baby: false, veg: false },
                printMode: '',
                showBulkImport: false,
                bulkNames: '',
                toast: { show: false, msg: '', icon: '' },
                assignModal: { show: false, guest: null },
                editModal: { show: false, table: {} },
                
                // Dragging Tables
                isDraggingTable: null,
                dragOffset: { x: 0, y: 0 },
                
                // Panning Canvas
                isPanning: false,
                panStart: { x: 0, y: 0 },
                scrollStart: { x: 0, y: 0 },

                init() {
                    this.loadData();
                    if (this.tables.length === 0) {
                        this.tables.push({ id: 1, name: 'ä¸»æ¡Œ', seats: 10, isMain: true, x: 100, y: 100 });
                        this.tables.push({ id: 2, name: 'ç¬¬ 2 æ¡Œ', seats: 10, isMain: false, x: 350, y: 100 });
                    }
                    this.tables.forEach((t, i) => {
                        if (t.x === undefined) t.x = (i % 3) * 250 + 50;
                        if (t.y === undefined) t.y = Math.floor(i / 3) * 300 + 50;
                    });
                    
                    this.$nextTick(() => {
                        this.initDragAndDrop();
                        const container = document.getElementById('map-scroll-container');
                        if(container) container.scrollTop = 0;
                    });
                },

                // --- Logic Methods ---
                loadData() {
                    const saved = localStorage.getItem('seating-chart-data');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.guests = data.guests || [];
                        this.tables = data.tables || [];
                    }
                },
                saveData() {
                    const data = { guests: this.guests, tables: this.tables };
                    localStorage.setItem('seating-chart-data', JSON.stringify(data));
                    this.showToast('å·²å„²å­˜', 'ğŸ’¾');
                },
                resetAll() {
                    if(!confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')) return;
                    this.guests = [];
                    this.tables = [{ id: 1, name: 'ä¸»æ¡Œ', seats: 10, isMain: true, x: 100, y: 100 }];
                    localStorage.removeItem('seating-chart-data');
                    this.$nextTick(() => this.initDragAndDrop());
                    this.showToast('å·²é‡ç½®', 'ğŸ§¹');
                },
                addGuest() {
                    if (!this.newGuestName.trim()) return;
                    this.guests.push({ 
                        id: Date.now() + Math.random().toString(36).substr(2, 5), 
                        name: this.newGuestName.trim(), 
                        tableId: null,
                        isBaby: this.newGuestTags.baby,
                        isVeg: this.newGuestTags.veg
                    });
                    this.newGuestName = '';
                    this.newGuestTags = { baby: false, veg: false };
                    this.saveData();
                },
                deleteGuest(id) {
                    this.guests = this.guests.filter(g => g.id !== id);
                    this.saveData();
                },
                toggleBulkImport() { this.showBulkImport = !this.showBulkImport; },
                processBulkImport() {
                    const names = this.bulkNames.split('\n').filter(n => n.trim());
                    names.forEach(n => this.guests.push({ id: Date.now() + Math.random().toString(36).substr(2, 5), name: n.trim(), tableId: null, isBaby: false, isVeg: false }));
                    this.bulkNames = ''; this.showBulkImport = false; this.saveData();
                },
                addTable() {
                    const nextId = this.tables.length > 0 ? Math.max(...this.tables.map(t => t.id)) + 1 : 1;
                    const last = this.tables[this.tables.length-1];
                    const newX = last ? last.x + 250 : 100;
                    const newY = last ? last.y : 100;
                    
                    this.tables.push({ id: nextId, name: `ç¬¬ ${nextId} æ¡Œ`, seats: 10, isMain: false, x: newX > 1500 ? 100 : newX, y: newX > 1500 ? newY + 300 : newY });
                    this.saveData();
                    this.$nextTick(() => this.initDragAndDrop());
                },
                deleteTable(id) {
                    if (!confirm('åˆªé™¤æ¡Œæ¬¡ï¼Ÿ')) return;
                    this.guests.forEach(g => { if (g.tableId === id) g.tableId = null; });
                    this.tables = this.tables.filter(t => t.id !== id);
                    this.saveData();
                },
                editTable(table) {
                    this.editModal.table = table;
                    this.editModal.show = true;
                },
                getTableGuests(tableId) { return this.guests.filter(g => g.tableId === tableId); },
                removeGuestFromTable(guestId) {
                    const guest = this.guests.find(g => g.id === guestId);
                    if (guest) { guest.tableId = null; this.saveData(); }
                },
                openAssignModal(guest) { this.assignModal.guest = guest; this.assignModal.show = true; },
                moveTo(tableId) {
                    if (this.assignModal.guest) { this.assignModal.guest.tableId = tableId; this.saveData(); this.assignModal.show = false; }
                },
                
                // --- Print Logic with Auto-Centering ---
                print(mode = 'map') {
                    this.printMode = 'print-' + mode;
                    if (mode === 'map') {
                        this.viewMode = 'map';
                        // Auto Fit Logic
                        const canvas = document.getElementById('venue-canvas');
                        if (canvas && this.tables.length > 0) {
                            // Find bounds
                            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
                            this.tables.forEach(t => {
                                if (t.x < minX) minX = t.x;
                                if (t.y < minY) minY = t.y;
                                if (t.x + 220 > maxX) maxX = t.x + 220; // 220 is approx width
                                if (t.y + 300 > maxY) maxY = t.y + 300; // 300 is approx height with guests
                            });
                            
                            // Add padding
                            const padding = 50;
                            minX -= padding; minY -= padding; maxX += padding; maxY += padding;
                            
                            const contentWidth = maxX - minX;
                            const contentHeight = maxY - minY;
                            
                            // Viewport size (approx A4 landscape in px)
                            const vpWidth = 1100; 
                            const vpHeight = 750;
                            
                            const scaleX = vpWidth / contentWidth;
                            const scaleY = vpHeight / contentHeight;
                            const scale = Math.min(scaleX, scaleY, 1); // Don't zoom in, only out
                            
                            // Center
                            const translateX = (vpWidth - contentWidth * scale) / 2 - minX * scale;
                            const translateY = (vpHeight - contentHeight * scale) / 2 - minY * scale;

                            // Apply to canvas for printing
                            canvas.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                            canvas.style.transformOrigin = 'top left';
                        }
                    }
                    
                    this.$nextTick(() => {
                        window.print();
                        // Reset
                        setTimeout(() => {
                            this.printMode = '';
                            const canvas = document.getElementById('venue-canvas');
                            if(canvas) {
                                canvas.style.transform = '';
                                canvas.style.transformOrigin = '';
                            }
                        }, 1000);
                    });
                },
                
                showToast(msg, icon) { this.toast = { show: true, msg, icon }; setTimeout(() => this.toast.show = false, 2000); },

                // --- Dragging Tables ---
                startDragTable(e, table) {
                    this.isDraggingTable = table.id;
                    const rect = e.target.closest('.draggable-table').getBoundingClientRect();
                    const container = document.querySelector('.venue-canvas').getBoundingClientRect();
                    this.dragOffset = { x: e.clientX - rect.left, y: e.clientY - rect.top };
                    
                    const moveHandler = (moveEvent) => {
                        const containerRect = document.querySelector('.venue-canvas').getBoundingClientRect();
                        // Adjust for canvas transform if present (but dragging usually happens in normal mode)
                        // Simple logic assumes scale 1 during edit
                        let x = moveEvent.clientX - containerRect.left - this.dragOffset.x;
                        let y = moveEvent.clientY - containerRect.top - this.dragOffset.y;
                        x = Math.round(x / 10) * 10;
                        y = Math.round(y / 10) * 10;
                        table.x = Math.max(0, x);
                        table.y = Math.max(0, y);
                    };

                    const upHandler = () => {
                        window.removeEventListener('mousemove', moveHandler);
                        window.removeEventListener('mouseup', upHandler);
                        this.isDraggingTable = null;
                        this.saveData();
                    };

                    window.addEventListener('mousemove', moveHandler);
                    window.addEventListener('mouseup', upHandler);
                },
                
                // Touch Drag for Tables
                startDragTableTouch(e, table) {
                   const touch = e.touches[0];
                   const rect = e.target.closest('.draggable-table').getBoundingClientRect();
                   this.dragOffset = { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
                   this.isDraggingTable = table.id;

                   const moveHandler = (moveEvent) => {
                       moveEvent.preventDefault();
                       const t = moveEvent.touches[0];
                       const containerRect = document.querySelector('.venue-canvas').getBoundingClientRect();
                       table.x = t.clientX - containerRect.left - this.dragOffset.x;
                       table.y = t.clientY - containerRect.top - this.dragOffset.y;
                   };
                   
                   const endHandler = () => {
                       window.removeEventListener('touchmove', moveHandler);
                       window.removeEventListener('touchend', endHandler);
                       this.isDraggingTable = null;
                       this.saveData();
                   }
                   window.addEventListener('touchmove', moveHandler, {passive: false});
                   window.addEventListener('touchend', endHandler);
                },

                // --- Panning Canvas (Desktop) ---
                startPan(e) {
                    this.isPanning = true;
                    this.panStart = { x: e.clientX, y: e.clientY };
                    const container = document.getElementById('map-scroll-container');
                    this.scrollStart = { x: container.scrollLeft, y: container.scrollTop };
                    container.style.cursor = 'grabbing';
                },
                pan(e) {
                    if (!this.isPanning) return;
                    e.preventDefault();
                    const container = document.getElementById('map-scroll-container');
                    const dx = e.clientX - this.panStart.x;
                    const dy = e.clientY - this.panStart.y;
                    container.scrollLeft = this.scrollStart.x - dx;
                    container.scrollTop = this.scrollStart.y - dy;
                },
                endPan() {
                    this.isPanning = false;
                    const container = document.getElementById('map-scroll-container');
                    if(container) container.style.cursor = 'grab';
                },

                // --- Sortable (Guests) ---
                initDragAndDrop() {
                    const poolEl = document.getElementById('guest-pool');
                    if (poolEl) {
                        if(poolEl._sortable) poolEl._sortable.destroy();
                        new Sortable(poolEl, { group: 'shared', animation: 150, delay: 200, delayOnTouchOnly: true, ghostClass: 'opacity-50', onEnd: (evt) => this.handleDrop(evt) });
                    }
                    
                    this.tables.forEach(table => {
                        const ids = [`list-table-${table.id}`, `map-table-${table.id}`];
                        ids.forEach(id => {
                            const el = document.getElementById(id);
                            if (el) {
                                if(el._sortable) el._sortable.destroy();
                                new Sortable(el, {
                                    group: 'shared', animation: 150, delay: 200, delayOnTouchOnly: true, ghostClass: 'bg-indigo-50',
                                    onAdd: (evt) => {
                                        const guestId = evt.item.getAttribute('data-id');
                                        this.assignGuest(guestId, table.id);
                                        evt.item.remove();
                                    }
                                });
                            }
                        });
                    });
                },
                assignGuest(guestId, tableId) {
                    const guest = this.guests.find(g => g.id == guestId);
                    if (guest) { guest.tableId = tableId; this.saveData(); }
                },
                handleDrop(evt) {}
            }
        }
    </script>
</body>
</html>